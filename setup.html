<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Daylee Calendar</title>
  <meta name="description" content="Your Daylee calendar â€“ see your events, weather, and more.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/uploads/images/favicon.png" type="image/png">
  <link href="/css/calendar.css" rel="stylesheet">
  <link href="/css/main.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <a href="/dashboard" id="top-link">< Dashboard</a>
  <div class="calendar-header">
    <img src="/uploads/images/daylee.png" alt="Daylee Logo" class="calendar-logo">
    <div class="calendar-title">Family Calendar</div>
    <div class="calendar-subtitle">See your family's events, weather, and more</div>
  </div>
  <div class="calendar-container">
    <button class="add-event-btn" id="addEventBtn" title="Add Event">+</button>
    <div class="calendar-controls">
      <button id="prevMonth">&lt;</button>
      <span id="monthYear"></span>
      <button id="nextMonth">&gt;</button>
    </div>
    <div class="calendar-grid" id="calendarGrid">
      <!-- Calendar will be rendered here -->
    </div>
  </div>
  <!-- Modal for adding event -->
  <div class="modal-bg" id="eventModalBg" style="display:none;">
    <div class="modal">
      <button class="modal-close" id="closeEventModal">&times;</button>
      <div class="modal-title">Add Event</div>
      <form class="modal-form" id="eventForm">
        <input type="text" id="eventTitle" placeholder="Event Title" required>
        <input type="date" id="eventDate" required>
        <input type="time" id="eventTime">
        <textarea id="eventDesc" placeholder="Description"></textarea>
        <button type="submit">Add Event</button>
      </form>
    </div>
  </div>
  <!-- Modal for day detail (hourly schedule) -->
  <div class="modal-bg" id="dayDetailModalBg" style="display:none;">
    <div class="day-detail-modal">
      <button class="modal-close" id="closeDayDetailModal">&times;</button>
      <div class="day-detail-title" id="dayDetailTitle"></div>
      <div class="hour-schedule" id="hourSchedule"></div>
    </div>
  </div>
  <!-- Tutorial Modal -->
  <div class="modal-bg" id="tutorialModalBg" style="display:none; z-index:10000;">
    <div class="modal">
      <button class="modal-close" id="closeTutorialModal">&times;</button>
      <div class="modal-title">Welcome to Daylee Calendar!</div>
      <div style="font-size:1.05rem; color:#22223b; margin-bottom:1.2rem;">
        <ul style="text-align:left; padding-left:1.2em; margin:0;">
          <li><b>Navigate months</b> with the <span style="color:#2563eb;">&lt;</span> and <span style="color:#2563eb;">&gt;</span> buttons.</li>
          <li><b>Add events</b> with the <span style="color:#06b6d4;">+</span> button in the top right or next to any hour.</li>
          <li><b>Click a day</b> to view and schedule events by the hour.</li>
          <li>Your events are shared with your family automatically.</li>
        </ul>
        <div style="margin-top:1.2em; color:#64748b; font-size:0.98em;">
          You can always revisit this tutorial from the menu.
        </div>
      </div>
      <button id="tutorialGotItBtn" class="modal-form" style="margin:0 auto; width:70%;">Got it!</button>
    </div>
  </div>
  <!-- Notification Container -->
  <div id="notification" style="display:none;position:fixed;top:1.2rem;right:1.2rem;z-index:12000;min-width:220px;max-width:90vw;padding:1rem 1.5rem;background:linear-gradient(90deg,#2563eb 0%,#06b6d4 100%);color:#fff;font-size:1.1rem;font-weight:600;border-radius:1em;box-shadow:0 4px 24px #2563eb33;transition:opacity 0.3s,transform 0.3s;opacity:0;pointer-events:none;"></div>

  <script>
    // --- Supabase Setup ---
    const SUPABASE_URL = "https://nmgikevqydvvjdgpdhjb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tZ2lrZXZxeWR2dmpkZ3BkaGpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzNzI4ODcsImV4cCI6MjA2Mzk0ODg4N30.1zPr-aOlkETD4FhuwhneHoXavSE6N0uNu-awxsidAZQ";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Calendar State ---
    const calendarGrid = document.getElementById('calendarGrid');
    const monthYear = document.getElementById('monthYear');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const addEventBtn = document.getElementById('addEventBtn');
    const eventModalBg = document.getElementById('eventModalBg');
    const closeEventModal = document.getElementById('closeEventModal');
    const eventForm = document.getElementById('eventForm');
    const dayDetailModalBg = document.getElementById('dayDetailModalBg');
    const closeDayDetailModal = document.getElementById('closeDayDetailModal');
    const dayDetailTitle = document.getElementById('dayDetailTitle');
    const hourSchedule = document.getElementById('hourSchedule');
    const eventTitle = document.getElementById('eventTitle');
    const eventDate = document.getElementById('eventDate');
    const eventTime = document.getElementById('eventTime');
    const eventDesc = document.getElementById('eventDesc');

    const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    let today = new Date();
    let currentMonth = today.getMonth();
    let currentYear = today.getFullYear();

    // Family calendar state
    let allFamilyEvents = []; // [{owner_name, owner_email, events: [{...}]}]
    let myProfile = null;
    let myFamilyId = null;
    let myOwnerName = null;
    let myOwnerEmail = null;

    // --- Supabase Auth & Family Fetch ---
    async function getProfileAndFamily() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        showNotification("Please sign in to use the family calendar.");
        return null;
      }
      const { data: profile } = await supabase
        .from('profiles')
        .select('*')
        .eq('email', user.email)
        .single();
      if (!profile) {
        showNotification("No profile found. Please join a family.");
        return null;
      }
      myProfile = profile;
      myFamilyId = profile.family_id;
      myOwnerName = profile.name;
      myOwnerEmail = profile.email;
      return profile;
    }

    // --- Load All Family Calendars ---
    async function loadFamilyCalendars() {
      if (!myFamilyId) return;
      const { data: calendars } = await supabase
        .from('calendars')
        .select('*')
        .eq('family_id', myFamilyId);
      allFamilyEvents = [];
      if (calendars && calendars.length) {
        calendars.forEach(c => {
          let evs = [];
          try { 
            evs = Array.isArray(c.events) ? c.events : JSON.parse(c.events || '[]'); 
          } catch { 
            evs = []; 
          }
          allFamilyEvents.push({
            owner_name: c.owner_name,
            owner_email: c.owner_email,
            events: evs
          });
        });
      }
      renderCalendar(currentMonth, currentYear);
    }

    // --- Save My Calendar to Supabase ---
    async function saveMyCalendar(events) {
      if (!myFamilyId || !myOwnerEmail || !myOwnerName) return;
      // If your Supabase column is jsonb, send as array. If text, send as string.
      // Most setups use jsonb:
      const { error } = await supabase
        .from('calendars')
        .upsert([{
          family_id: myFamilyId,
          owner_email: myOwnerEmail,
          owner_name: myOwnerName,
          events: events // If you get 400, try JSON.stringify(events)
        }], { onConflict: ['family_id', 'owner_email'] });
      if (error) {
        console.error('Supabase upsert error:', error);
        showNotification('Failed to save event: ' + error.message);
      }
    }

    // --- Merge All Family Events for Display ---
    function getAllEventsForMonth(month, year) {
      let merged = [];
      allFamilyEvents.forEach(famCal => {
        famCal.events.forEach(e => {
          if (e.date) {
            const d = new Date(e.date);
            if (!isNaN(d) && d.getMonth() === month && d.getFullYear() === year) {
              merged.push({ ...e, owner_name: famCal.owner_name });
            }
          }
        });
      });
      return merged;
    }

    // --- Calendar Rendering (with Family Events) ---
    function renderCalendar(month, year) {
      calendarGrid.innerHTML = '';
      // Days of week header
      daysOfWeek.forEach(day => {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        dayDiv.textContent = day;
        calendarGrid.appendChild(dayDiv);
      });

      // First day of month
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // Fill blanks before first day
      for (let i = 0; i < firstDay; i++) {
        const blank = document.createElement('div');
        blank.className = 'calendar-cell';
        blank.style.background = 'transparent';
        blank.style.cursor = 'default';
        calendarGrid.appendChild(blank);
      }

      // Fill days
      const mergedEvents = getAllEventsForMonth(month, year);
      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        const cellDate = new Date(year, month, day);
        const cellDateStr = cellDate.toISOString().slice(0, 10);

        if (
          day === today.getDate() &&
          month === today.getMonth() &&
          year === today.getFullYear()
        ) {
          cell.classList.add('today');
        }
        // Day number
        const dayNum = document.createElement('div');
        dayNum.className = 'calendar-day-number';
        dayNum.textContent = day;
        cell.appendChild(dayNum);

        // Show events for this day (from all family members)
        const dayEvents = mergedEvents.filter(e => {
          return (e.date === cellDateStr) ||
            (e.date && new Date(e.date).toISOString().slice(0, 10) === cellDateStr);
        });
        if (dayEvents.length > 0) {
          const eventsDiv = document.createElement('div');
          eventsDiv.className = 'calendar-events';
          dayEvents.forEach(e => {
            const ev = document.createElement('div');
            ev.className = 'calendar-event';
            ev.innerHTML = `<span style="color:#2563eb;font-weight:600;">${e.owner_name}:</span> ${e.time ? `<b>${e.time}</b> ` : ''}${e.title}${e.desc ? `<br><span style='color:#64748b;font-size:0.97em;'>${e.desc}</span>` : ''}`;
            eventsDiv.appendChild(ev);
          });
          cell.appendChild(eventsDiv);
        }

        // Click to open day detail
        cell.addEventListener('click', () => openDayDetail(cellDateStr, day, month, year));
        calendarGrid.appendChild(cell);
      }
    }

    function updateMonthYear() {
      const date = new Date(currentYear, currentMonth);
      const options = { month: 'long', year: 'numeric' };
      monthYear.textContent = date.toLocaleDateString(undefined, options);
    }

    prevMonthBtn.onclick = function() {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      updateMonthYear();
      renderCalendar(currentMonth, currentYear);
    };

    nextMonthBtn.onclick = function() {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      updateMonthYear();
      renderCalendar(currentMonth, currentYear);
    };

    // --- Add Event Modal ---
    addEventBtn.onclick = function() {
      eventModalBg.style.display = 'flex';
      eventTitle.value = '';
      eventDate.value = '';
      eventTime.value = '';
      eventDesc.value = '';
      setTimeout(() => {
        eventModalBg.querySelector('.modal').style.transform = 'scale(1)';
      }, 10);
    };
    closeEventModal.onclick = function() {
      eventModalBg.style.display = 'none';
    };
    eventModalBg.onclick = function(e) {
      if (e.target === eventModalBg) eventModalBg.style.display = 'none';
    };

    eventForm.onsubmit = async function(e) {
      e.preventDefault();
      const newEvent = {
        title: eventTitle.value,
        date: eventDate.value,
        time: eventTime.value,
        desc: eventDesc.value
      };
      // Load my current events from my family calendar
      let myCal = allFamilyEvents.find(f => f.owner_email === myOwnerEmail);
      let myEvents = myCal ? myCal.events : [];
      myEvents.push(newEvent);
      // Save to Supabase and wait for it to finish
      await saveMyCalendar(myEvents);
      // Now reload all family calendars (this will re-render)
      await loadFamilyCalendars();
      eventModalBg.style.display = 'none';
      showNotification('Event added and shared with your family!');
      scheduleEventNotifications();
    };

    // --- Day Detail Modal (hourly schedule) ---
    function openDayDetail(dateStr, day, month, year) {
      dayDetailModalBg.style.display = 'flex';
      dayDetailTitle.textContent = `${daysOfWeek[new Date(year, month, day).getDay()]}, ${month + 1}/${day}/${year}`;
      renderHourSchedule(dateStr);
    }
    closeDayDetailModal.onclick = function() {
      dayDetailModalBg.style.display = 'none';
    };
    dayDetailModalBg.onclick = function(e) {
      if (e.target === dayDetailModalBg) dayDetailModalBg.style.display = 'none';
    };

    function renderHourSchedule(dateStr) {
      hourSchedule.innerHTML = '';
      // Merge all family events for this day
      let allDayEvents = [];
      allFamilyEvents.forEach(famCal => {
        famCal.events.forEach(e => {
          if (e.date === dateStr) allDayEvents.push({ ...e, owner_name: famCal.owner_name });
        });
      });
      for (let h = 0; h < 24; h++) {
        const hourLabel = `${h.toString().padStart(2, '0')}:00`;
        const hourRow = document.createElement('div');
        hourRow.className = 'hour-row';
        const label = document.createElement('div');
        label.className = 'hour-label';
        label.textContent = hourLabel;
        const eventsDiv = document.createElement('div');
        eventsDiv.className = 'hour-events';
        const hourEvents = allDayEvents.filter(e => e.time && e.time.startsWith(hourLabel.slice(0,2)));
        if (hourEvents.length > 0) {
          eventsDiv.innerHTML = hourEvents.map(e =>
            `<span style="color:#2563eb;font-weight:600;">${e.owner_name}:</span> <b>${e.time}</b> ${e.title}<br><span style="color:#64748b;font-size:0.95em;">${e.desc || ''}</span>`
          ).join('<br>');
        }

        // Add button to schedule new event at this hour (for yourself)
        const addBtn = document.createElement('button');
        addBtn.className = 'add-hour-event-btn';
        addBtn.textContent = '+';
        addBtn.title = `Add event at ${hourLabel}`;
        addBtn.onclick = function() {
          // Prefill modal for this hour
          dayDetailModalBg.style.display = 'none'; // Close the scheduler modal
          eventModalBg.style.display = 'flex';
          eventTitle.value = '';
          eventDate.value = dateStr;
          eventTime.value = hourLabel.slice(0,2) + ':00';
          eventDesc.value = '';
        };

        hourRow.appendChild(label);
        hourRow.appendChild(eventsDiv);
        hourRow.appendChild(addBtn);
        hourSchedule.appendChild(hourRow);
      }
    }

    // --- Tutorial Modal Logic ---
    const tutorialModalBg = document.getElementById('tutorialModalBg');
    const closeTutorialModal = document.getElementById('closeTutorialModal');
    const tutorialGotItBtn = document.getElementById('tutorialGotItBtn');

    function showTutorialIfFirstTime() {
      if (!localStorage.getItem('dayleeCalendarTutorialSeen')) {
        tutorialModalBg.style.display = 'flex';
        localStorage.setItem('dayleeCalendarTutorialSeen', 'yes');
      }
    }
    closeTutorialModal.onclick = function() {
      tutorialModalBg.style.display = 'none';
    };
    tutorialGotItBtn.onclick = function() {
      tutorialModalBg.style.display = 'none';
    };

    // --- Notification Logic ---
    function showNotification(msg, duration = 3500) {
      const notif = document.getElementById('notification');
      notif.textContent = msg;
      notif.style.display = 'block';
      notif.style.opacity = '1';
      notif.style.transform = 'translateY(0)';
      notif.style.pointerEvents = 'auto';
      setTimeout(() => {
        notif.style.opacity = '0';
        notif.style.transform = 'translateY(-30px)';
        notif.style.pointerEvents = 'none';
        setTimeout(() => {
          notif.style.display = 'none';
        }, 400);
      }, duration);
    }

    // --- Request Notification Permission on first load ---
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }
    window.addEventListener('DOMContentLoaded', requestNotificationPermission);

    // --- Schedule Event Notifications ---
    function scheduleEventNotifications() {
      if (!('Notification' in window) || Notification.permission !== 'granted') return;
      // Clear any previous intervals
      if (window.dayleeNotifInterval) clearInterval(window.dayleeNotifInterval);

      window.dayleeNotifInterval = setInterval(() => {
        const now = new Date();
        const nowStr = now.toISOString().slice(0, 16); // "YYYY-MM-DDTHH:MM"
        let notifiedEvents = JSON.parse(localStorage.getItem('dayleeNotifiedEvents') || '[]');
        // Only notify for your own events
        let myCal = allFamilyEvents.find(f => f.owner_email === myOwnerEmail);
        let myEvents = myCal ? myCal.events : [];
        myEvents.forEach(e => {
          if (e.date && e.time) {
            const eventDateTime = `${e.date}T${e.time}`;
            // Notify if event is within the next 5 minutes and not already notified
            const eventTime = new Date(eventDateTime);
            const diff = (eventTime - now) / 60000; // minutes
            if (diff >= 0 && diff < 5 && !notifiedEvents.includes(eventDateTime + e.title)) {
              // Show browser notification
              new Notification('Daylee Event Reminder', {
                body: `${e.title}${e.time ? ' at ' + e.time : ''}${e.desc ? '\n' + e.desc : ''}`,
                icon: '/uploads/images/daylee.png'
              });
              // Show in-app notification
              showNotification(`Upcoming: ${e.title}${e.time ? ' at ' + e.time : ''}`);
              notifiedEvents.push(eventDateTime + e.title);
            }
          }
        });
        // Save notified events to avoid duplicate notifications
        localStorage.setItem('dayleeNotifiedEvents', JSON.stringify(notifiedEvents));
      }, 60000); // Check every minute
    }

    // --- Initial Render & Sync ---
    async function initialLoadAndSync() {
      const profile = await getProfileAndFamily();
      if (!profile) return;
      // Load all family calendars
      await loadFamilyCalendars();
      // If user has no calendar, create one
      let myCal = allFamilyEvents.find(f => f.owner_email === myOwnerEmail);
      if (!myCal) {
        await saveMyCalendar([]);
        await loadFamilyCalendars();
      }
      updateMonthYear();
      renderCalendar(currentMonth, currentYear);
      scheduleEventNotifications();
      showTutorialIfFirstTime();
      // Live sync: subscribe to changes in the calendars table for this family
      supabase
        .channel('calendars')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'calendars', filter: `family_id=eq.${myFamilyId}` }, async payload => {
          await loadFamilyCalendars();
        })
        .subscribe();
    }

    window.addEventListener('DOMContentLoaded', initialLoadAndSync);
  </script>
  <footer>
    Daylee -  Organize your life, your way.
  </footer>
</body>
</html>