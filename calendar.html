<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Daylee Calendar</title>
  <meta name="description" content="Your Daylee calendar – see your events, weather, and more.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/uploads/images/favicon.png" type="image/png">
  <link href="/css/calendar.css" rel="stylesheet">
  <link href="/css/main.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <a href="/dashboard" id="top-link">< Dashboard</a>
  <div class="calendar-header">
    <img src="/uploads/images/daylee.png" alt="Daylee Logo" class="calendar-logo">
    <div class="calendar-title">Family Calendar</div>
    <div class="calendar-subtitle">See your family's events, weather, and more</div>
  </div>
  <div class="calendar-container">
    <button class="add-event-btn" id="addEventBtn" title="Add Event">+</button>
    <div class="calendar-controls">
      <button id="prevMonth">&lt;</button>
      <span id="monthYear"></span>
      <button id="nextMonth">&gt;</button>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
  </div>
  <!-- Modal for adding event -->
  <div class="modal-bg" id="eventModalBg" style="display:none;">
    <div class="modal">
      <button class="modal-close" id="closeEventModal">&times;</button>
      <div class="modal-title">Add Event</div>
      <form class="modal-form" id="eventForm">
        <input type="text" id="eventTitle" placeholder="Event Title" required>
        <input type="date" id="eventDate" required>
        <input type="time" id="eventTime">
        <textarea id="eventDesc" placeholder="Description"></textarea>
        <button type="submit">Add Event</button>
      </form>
    </div>
  </div>
  <!-- Modal for day detail (hourly schedule) -->
  <div class="modal-bg" id="dayDetailModalBg" style="display:none;">
    <div class="day-detail-modal">
      <button class="modal-close" id="closeDayDetailModal">&times;</button>
      <div class="day-detail-title" id="dayDetailTitle"></div>
      <div class="hour-schedule" id="hourSchedule"></div>
    </div>
  </div>
  <!-- Tutorial Modal -->
  <div class="modal-bg" id="tutorialModalBg" style="display:none; z-index:10000;">
    <div class="modal">
      <button class="modal-close" id="closeTutorialModal">&times;</button>
      <div class="modal-title">Welcome to Daylee Calendar!</div>
      <div style="font-size:1.05rem; color:#22223b; margin-bottom:1.2rem;">
        <ul style="text-align:left; padding-left:1.2em; margin:0;">
          <li><b>Navigate months</b> with the <span style="color:#2563eb;">&lt;</span> and <span style="color:#2563eb;">&gt;</span> buttons.</li>
          <li><b>Add events</b> with the <span style="color:#06b6d4;">+</span> button in the top right or next to any hour.</li>
          <li><b>Click a day</b> to view and schedule events by the hour.</li>
          <li>Your events are shared with your family automatically.</li>
        </ul>
        <div style="margin-top:1.2em; color:#64748b; font-size:0.98em;">
          You can always revisit this tutorial from the menu.
        </div>
      </div>
      <button id="tutorialGotItBtn" class="modal-form" style="margin:0 auto; width:70%;">Got it!</button>
    </div>
  </div>
  <!-- Notification Container -->
  <div id="notification" style="display:none;position:fixed;top:1.2rem;right:1.2rem;z-index:12000;min-width:220px;max-width:90vw;padding:1rem 1.5rem;background:linear-gradient(90deg,#2563eb 0%,#06b6d4 100%);color:#fff;font-size:1.1rem;font-weight:600;border-radius:1em;box-shadow:0 4px 24px #2563eb33;transition:opacity 0.3s,transform 0.3s;opacity:0;pointer-events:none;"></div>
<!-- ... Everything before this remains unchanged ... -->
<script>
const supabase = createClient(
  "https://yokrcscbxfqucigedgqn.supabase.co",
  "your-supabase-anon-key"
);

let myProfile = null;
let myFamilyId = null;
let myOwnerName = "";
let myOwnerEmail = "";
let familyEvents = [];

const calendarGrid = document.getElementById("calendarGrid");
const dayModalBg = document.getElementById("dayModalBg");
const eventModalBg = document.getElementById("eventModalBg");
const selectedDateDisplay = document.getElementById("selectedDateDisplay");
const eventForm = document.getElementById("eventForm");
const eventTitle = document.getElementById("eventTitle");
const eventTime = document.getElementById("eventTime");
const eventDesc = document.getElementById("eventDesc");
const eventDate = document.getElementById("eventDate");
const notification = document.getElementById("notification");

async function getProfileAndFamily() {
  const { data, error } = await supabase.auth.getUser();
  if (error || !data?.user) {
    showNotification("Please sign in.");
    return null;
  }

  const user = data.user;

  const { data: profile, error: profileError } = await supabase
    .from("profiles")
    .select("*")
    .eq("email", user.email)
    .single();

  if (profileError || !profile) {
    showNotification("No profile found.");
    return null;
  }

  myProfile = profile;
  myFamilyId = profile.family_id;
  myOwnerName = profile.name;
  myOwnerEmail = profile.email;
  return profile;
}

async function loadFamilyCalendar() {
  if (!myFamilyId) return;

  const { data, error } = await supabase
    .from("calendars")
    .select("events")
    .eq("family_id", myFamilyId)
    .single();

  if (error) {
    console.error("Failed to load calendar:", error);
    showNotification("Error loading calendar.");
    return;
  }

  familyEvents = data?.events || [];
  renderCalendar();
}

async function saveFamilyCalendar(events) {
  if (!myFamilyId) return;

  const { error } = await supabase
    .from("calendars")
    .upsert([{ family_id: myFamilyId, events }], { onConflict: ["family_id"] });

  if (error) {
    console.error("Supabase upsert error:", error);
    showNotification("Failed to save event: " + error.message);
  }
}

function renderCalendar() {
  if (!calendarGrid) return;

  calendarGrid.innerHTML = "";

  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const firstDay = new Date(year, month, 1).getDay();
  const lastDate = new Date(year, month + 1, 0).getDate();

  for (let i = 0; i < firstDay; i++) {
    const emptyCell = document.createElement("div");
    calendarGrid.appendChild(emptyCell);
  }

  for (let date = 1; date <= lastDate; date++) {
    const cell = document.createElement("div");
    cell.className = "calendar-cell";
    const fullDate = `${year}-${String(month + 1).padStart(2, "0")}-${String(date).padStart(2, "0")}`;
    cell.dataset.date = fullDate;
    cell.innerHTML = `<div>${date}</div>`;

    const eventsToday = familyEvents.filter(e => e.date === fullDate);
    eventsToday.forEach(e => {
      const badge = document.createElement("div");
      badge.className = "event-badge";
      badge.innerText = e.title;
      cell.appendChild(badge);
    });

    cell.onclick = () => openDayModal(fullDate);
    calendarGrid.appendChild(cell);
  }
}

function openDayModal(dateStr) {
  selectedDateDisplay.innerText = `Events on ${dateStr}`;
  const events = familyEvents.filter(e => e.date === dateStr);

  const list = document.getElementById("eventList");
  list.innerHTML = "";

  events.forEach(e => {
    const item = document.createElement("li");
    item.innerHTML = `<strong>${e.title}</strong> @ ${e.time || "all day"} — ${e.desc || ""}`;
    list.appendChild(item);
  });

  eventDate.value = dateStr;
  dayModalBg.style.display = "block";
}

document.getElementById("closeDayModal").onclick = () => {
  dayModalBg.style.display = "none";
};

document.getElementById("closeEventModal").onclick = () => {
  eventModalBg.style.display = "none";
};

document.getElementById("addEventButton").onclick = () => {
  dayModalBg.style.display = "none";
  eventModalBg.style.display = "block";
};

eventForm.onsubmit = async function (e) {
  e.preventDefault();

  if (!eventTitle.value || !eventDate.value) {
    showNotification("Please fill in the event title and date.");
    return;
  }

  const newEvent = {
    title: eventTitle.value.trim(),
    date: eventDate.value,
    time: eventTime.value,
    desc: eventDesc.value,
    owner: myOwnerName,
  };

  familyEvents.push(newEvent);
  await saveFamilyCalendar(familyEvents);
  await loadFamilyCalendar();

  eventModalBg.style.display = "none";
  showNotification("Event added and shared with your family!");
};

function showNotification(msg) {
  if (!notification) return;
  notification.innerText = msg;
  notification.style.display = "block";
  setTimeout(() => {
    notification.style.display = "none";
  }, 3000);
}

window.addEventListener("DOMContentLoaded", async () => {
  await getProfileAndFamily();
  await loadFamilyCalendar();
});
</script>

  <footer>
    Daylee -  Organize your life, your way.
  </footer>
</body>
</html>
