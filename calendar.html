<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Daylee Calendar</title>
  <meta name="description" content="Your Daylee calendar â€“ see your events, weather, and more.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/uploads/images/favicon.png" type="image/png">
  <link href="/css/calendar.css" rel="stylesheet">
  <link href="/css/main.css" rel="stylesheet">

</head>
<body>
  <a><div id="top-link"><i class="fa-solid fa-arrow-left"></i> Dashboard</div></a>
  <div class="calendar-header">
    <img src="/uploads/images/daylee.png" alt="Daylee Logo" class="calendar-logo">
    <div class="calendar-title">Your Calendar</div>
    <div class="calendar-subtitle">See your events, weather, and more</div>
  </div>
  <div class="calendar-container">
    <button class="add-event-btn" id="addEventBtn" title="Add Event">+</button>
    <div class="calendar-controls">
      <button id="prevMonth">&lt;</button>
      <span id="monthYear"></span>
      <button id="nextMonth">&gt;</button>
    </div>
    <div class="calendar-grid" id="calendarGrid">
      <!-- Calendar will be rendered here -->
    </div>
  </div>
  <!-- Modal for adding event -->
  <div class="modal-bg" id="eventModalBg" style="display:none;">
    <div class="modal">
      <button class="modal-close" id="closeEventModal">&times;</button>
      <div class="modal-title">Add Event</div>
      <form class="modal-form" id="eventForm">
        <input type="text" id="eventTitle" placeholder="Event Title" required>
        <input type="date" id="eventDate" required>
        <input type="time" id="eventTime">
        <textarea id="eventDesc" placeholder="Description"></textarea>
        <button type="submit">Add Event</button>
      </form>
    </div>
  </div>
  <!-- Modal for day detail (hourly schedule) -->
  <div class="modal-bg" id="dayDetailModalBg" style="display:none;">
    <div class="day-detail-modal">
      <button class="modal-close" id="closeDayDetailModal">&times;</button>
      <div class="day-detail-title" id="dayDetailTitle"></div>
      <div class="hour-schedule" id="hourSchedule"></div>
    </div>
  </div>
  <!-- Tutorial Modal -->
  <div class="modal-bg" id="tutorialModalBg" style="display:none; z-index:10000;">
    <div class="modal">
      <button class="modal-close" id="closeTutorialModal">&times;</button>
      <div class="modal-title">Welcome to Daylee Calendar!</div>
      <div style="font-size:1.05rem; color:#22223b; margin-bottom:1.2rem;">
        <ul style="text-align:left; padding-left:1.2em; margin:0;">
          <li><b>Navigate months</b> with the <span style="color:#2563eb;">&lt;</span> and <span style="color:#2563eb;">&gt;</span> buttons.</li>
          <li><b>Add events</b> with the <span style="color:#06b6d4;">+</span> button in the top right or next to any hour.</li>
          <li><b>Click a day</b> to view and schedule events by the hour.</li>
          <li>Your events are saved in your browser automatically.</li>
        </ul>
        <div style="margin-top:1.2em; color:#64748b; font-size:0.98em;">
          You can always revisit this tutorial from the menu.
        </div>
      </div>
   <button id="tutorialGotItBtn" class="modal-form" style="margin:0 auto; width:70%;">Got it!</button>
</div>
  </div>
  <!-- Notification Container -->
  <div id="notification" style="display:none;position:fixed;top:1.2rem;right:1.2rem;z-index:12000;min-width:220px;max-width:90vw;padding:1rem 1.5rem;background:linear-gradient(90deg,#2563eb 0%,#06b6d4 100%);color:#fff;font-size:1.1rem;font-weight:600;border-radius:1em;box-shadow:0 4px 24px #2563eb33;transition:opacity 0.3s,transform 0.3s;opacity:0;pointer-events:none;"></div>

  <script>
    // --- Calendar State ---
    const calendarGrid = document.getElementById('calendarGrid');
    const monthYear = document.getElementById('monthYear');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const addEventBtn = document.getElementById('addEventBtn');
    const eventModalBg = document.getElementById('eventModalBg');
    const closeEventModal = document.getElementById('closeEventModal');
    const eventForm = document.getElementById('eventForm');
    const dayDetailModalBg = document.getElementById('dayDetailModalBg');
    const closeDayDetailModal = document.getElementById('closeDayDetailModal');
    const dayDetailTitle = document.getElementById('dayDetailTitle');
    const hourSchedule = document.getElementById('hourSchedule');
    const eventTitle = document.getElementById('eventTitle');
    const eventDate = document.getElementById('eventDate');
    const eventTime = document.getElementById('eventTime');
    const eventDesc = document.getElementById('eventDesc');

    const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    let today = new Date();
    let currentMonth = today.getMonth();
    let currentYear = today.getFullYear();

    // Store events as { date: 'YYYY-MM-DD', time: 'HH:MM', title, desc }
    let events = JSON.parse(localStorage.getItem('dayleeEvents') || '[]');

    // --- Calendar Rendering ---
    function renderCalendar(month, year) {
      calendarGrid.innerHTML = '';
      // Days of week header
      daysOfWeek.forEach(day => {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        dayDiv.textContent = day;
        calendarGrid.appendChild(dayDiv);
      });

      // First day of month
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // Fill blanks before first day
      for (let i = 0; i < firstDay; i++) {
        const blank = document.createElement('div');
        blank.className = 'calendar-cell';
        blank.style.background = 'transparent';
        blank.style.cursor = 'default';
        calendarGrid.appendChild(blank);
      }

      // Fill days
      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        const cellDate = new Date(year, month, day);
        const cellDateStr = cellDate.toISOString().slice(0, 10);

        if (
          day === today.getDate() &&
          month === today.getMonth() &&
          year === today.getFullYear()
        ) {
          cell.classList.add('today');
        }
        cell.textContent = day;

        // Show events for this day
        const dayEvents = events.filter(e => e.date === cellDateStr);
        if (dayEvents.length > 0) {
          const eventsDiv = document.createElement('div');
          eventsDiv.className = 'calendar-events';
          eventsDiv.innerHTML = dayEvents.map(e =>
            (e.time ? `<b>${e.time}</b> ` : '') + e.title
          ).join('<br>');
          cell.appendChild(eventsDiv);
        }

        // Click to open day detail
        cell.addEventListener('click', () => openDayDetail(cellDateStr, day, month, year));
        calendarGrid.appendChild(cell);
      }
    }

    function updateMonthYear() {
      const date = new Date(currentYear, currentMonth);
      const options = { month: 'long', year: 'numeric' };
      monthYear.textContent = date.toLocaleDateString(undefined, options);
    }

    prevMonthBtn.onclick = function() {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      updateMonthYear();
      renderCalendar(currentMonth, currentYear);
    };

    nextMonthBtn.onclick = function() {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      updateMonthYear();
      renderCalendar(currentMonth, currentYear);
    };

    // --- Add Event Modal ---
    addEventBtn.onclick = function() {
      eventModalBg.style.display = 'flex';
      eventTitle.value = '';
      eventDate.value = '';
      eventTime.value = '';
      eventDesc.value = '';
      setTimeout(() => {
        eventModalBg.querySelector('.modal').style.transform = 'scale(1)';
      }, 10);
    };
    closeEventModal.onclick = function() {
      eventModalBg.style.display = 'none';
    };
    eventModalBg.onclick = function(e) {
      if (e.target === eventModalBg) eventModalBg.style.display = 'none';
    };

    eventForm.onsubmit = function(e) {
      e.preventDefault();
      const newEvent = {
        title: eventTitle.value,
        date: eventDate.value,
        time: eventTime.value,
        desc: eventDesc.value
      };
      events.push(newEvent);
      localStorage.setItem('dayleeEvents', JSON.stringify(events));
      eventModalBg.style.display = 'none';
      renderCalendar(currentMonth, currentYear);
      showNotification('Event added!');
      scheduleEventNotifications();
    };

    // --- Day Detail Modal (hourly schedule) ---
    function openDayDetail(dateStr, day, month, year) {
      dayDetailModalBg.style.display = 'flex';
      dayDetailTitle.textContent = `${daysOfWeek[new Date(year, month, day).getDay()]}, ${month + 1}/${day}/${year}`;
      renderHourSchedule(dateStr);
    }
    closeDayDetailModal.onclick = function() {
      dayDetailModalBg.style.display = 'none';
    };
    dayDetailModalBg.onclick = function(e) {
      if (e.target === dayDetailModalBg) dayDetailModalBg.style.display = 'none';
    };

    function renderHourSchedule(dateStr) {
      hourSchedule.innerHTML = '';
      for (let h = 0; h < 24; h++) {
        const hourLabel = `${h.toString().padStart(2, '0')}:00`;
        const hourRow = document.createElement('div');
        hourRow.className = 'hour-row';
        const label = document.createElement('div');
        label.className = 'hour-label';
        label.textContent = hourLabel;
        const eventsDiv = document.createElement('div');
        eventsDiv.className = 'hour-events';
        const hourEvents = events.filter(e => e.date === dateStr && e.time && e.time.startsWith(hourLabel.slice(0,2)));
        if (hourEvents.length > 0) {
          eventsDiv.innerHTML = hourEvents.map(e =>
            `<b>${e.time}</b> ${e.title}<br><span style="color:#64748b;font-size:0.95em;">${e.desc || ''}</span>`
          ).join('<br>');
        }

        // Add button to schedule new event at this hour
        const addBtn = document.createElement('button');
        addBtn.className = 'add-hour-event-btn';
        addBtn.textContent = '+';
        addBtn.title = `Add event at ${hourLabel}`;
        addBtn.onclick = function() {
          // Prefill modal for this hour
          dayDetailModalBg.style.display = 'none'; // Close the scheduler modal
          eventModalBg.style.display = 'flex';
          eventTitle.value = '';
          eventDate.value = dateStr;
          eventTime.value = hourLabel.slice(0,2) + ':00';
          eventDesc.value = '';
        };

        hourRow.appendChild(label);
        hourRow.appendChild(eventsDiv);
        hourRow.appendChild(addBtn);
        hourSchedule.appendChild(hourRow);
      }
    }

    // --- Tutorial Modal Logic ---
    const tutorialModalBg = document.getElementById('tutorialModalBg');
    const closeTutorialModal = document.getElementById('closeTutorialModal');
    const tutorialGotItBtn = document.getElementById('tutorialGotItBtn');

    function showTutorialIfFirstTime() {
      if (!localStorage.getItem('dayleeCalendarTutorialSeen')) {
        tutorialModalBg.style.display = 'flex';
        localStorage.setItem('dayleeCalendarTutorialSeen', 'yes');
      }
    }
    closeTutorialModal.onclick = function() {
      tutorialModalBg.style.display = 'none';
    };
    tutorialGotItBtn.onclick = function() {
      tutorialModalBg.style.display = 'none';
    };

    // --- Notification Logic ---
    function showNotification(msg, duration = 3500) {
      const notif = document.getElementById('notification');
      notif.textContent = msg;
      notif.style.display = 'block';
      notif.style.opacity = '1';
      notif.style.transform = 'translateY(0)';
      notif.style.pointerEvents = 'auto';
      setTimeout(() => {
        notif.style.opacity = '0';
        notif.style.transform = 'translateY(-30px)';
        notif.style.pointerEvents = 'none';
        setTimeout(() => {
          notif.style.display = 'none';
        }, 400);
      }, duration);
    }

    // --- Request Notification Permission on first load ---
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }
    window.addEventListener('DOMContentLoaded', requestNotificationPermission);

    // --- Schedule Event Notifications ---
    function scheduleEventNotifications() {
      if (!('Notification' in window) || Notification.permission !== 'granted') return;
      // Clear any previous intervals
      if (window.dayleeNotifInterval) clearInterval(window.dayleeNotifInterval);

      window.dayleeNotifInterval = setInterval(() => {
        const now = new Date();
        const nowStr = now.toISOString().slice(0, 16); // "YYYY-MM-DDTHH:MM"
        let notifiedEvents = JSON.parse(localStorage.getItem('dayleeNotifiedEvents') || '[]');
        events.forEach(e => {
          if (e.date && e.time) {
            const eventDateTime = `${e.date}T${e.time}`;
            // Notify if event is within the next 5 minutes and not already notified
            const eventTime = new Date(eventDateTime);
            const diff = (eventTime - now) / 60000; // minutes
            if (diff >= 0 && diff < 5 && !notifiedEvents.includes(eventDateTime + e.title)) {
              // Show browser notification
              new Notification('Daylee Event Reminder', {
                body: `${e.title}${e.time ? ' at ' + e.time : ''}${e.desc ? '\n' + e.desc : ''}`,
                icon: '/uploads/images/daylee.png'
              });
              // Show in-app notification
              showNotification(`Upcoming: ${e.title}${e.time ? ' at ' + e.time : ''}`);
              notifiedEvents.push(eventDateTime + e.title);
            }
          }
        });
        // Save notified events to avoid duplicate notifications
        localStorage.setItem('dayleeNotifiedEvents', JSON.stringify(notifiedEvents));
      }, 60000); // Check every minute
    }

    // Call this after events are loaded or changed
    scheduleEventNotifications();

    // --- Initial Render ---
    updateMonthYear();
    renderCalendar(currentMonth, currentYear);
    window.addEventListener('DOMContentLoaded', showTutorialIfFirstTime);
  </script>
</body>
</html>
