<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daylee Calendar</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f8f9fa;
    }
    header {
      background-color: #0d6efd;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    #notification {
      background-color: #ffc107;
      color: black;
      padding: 0.5rem;
      text-align: center;
      display: none;
    }
    #calendarGrid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background-color: #dee2e6;
      padding: 1rem;
    }
    .calendar-cell {
      background: white;
      padding: 0.5rem;
      height: 100px;
      overflow-y: auto;
      border: 1px solid #ccc;
      cursor: pointer;
      position: relative;
    }
    .event-badge {
      background: #0d6efd;
      color: white;
      font-size: 0.75rem;
      padding: 2px 4px;
      margin-top: 4px;
      display: inline-block;
      border-radius: 4px;
    }
    .modal-bg {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal {
      background: white;
      padding: 1rem;
      width: 300px;
      border-radius: 8px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header button {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
    }
    form > div {
      margin-bottom: 0.75rem;
    }
    button {
      background: #0d6efd;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-radius: 4px;
    }
  </style>
</head>
<body>

  <header>
    <h1>Daylee Family Calendar</h1>
  </header>

  <div id="notification"></div>

  <div id="calendarGrid"></div>

  <!-- View Day Modal -->
  <div id="dayModalBg" class="modal-bg">
    <div class="modal">
      <div class="modal-header">
        <h3 id="selectedDateDisplay">Events</h3>
        <button id="closeDayModal">&times;</button>
      </div>
      <ul id="eventList"></ul>
      <button id="addEventButton">+ Add Event</button>
    </div>
  </div>

  <!-- Add Event Modal -->
  <div id="eventModalBg" class="modal-bg">
    <div class="modal">
      <div class="modal-header">
        <h3>Add Event</h3>
        <button id="closeEventModal">&times;</button>
      </div>
      <form id="eventForm">
        <div>
          <label>Title</label>
          <input type="text" id="eventTitle" required />
        </div>
        <div>
          <label>Time</label>
          <input type="time" id="eventTime" />
        </div>
        <div>
          <label>Description</label>
          <textarea id="eventDesc" rows="2"></textarea>
        </div>
        <input type="hidden" id="eventDate" />
        <button type="submit">Save Event</button>
      </form>
    </div>
  </div>

  <script type="module" src="daylee.js">
import { createClient } from "https://cdn.skypack.dev/@supabase/supabase-js";

const supabase = createClient(
  "https://yokrcscbxfqucigedgqn.supabase.co",
  "your-supabase-anon-key"
);

let myProfile = null;
let myFamilyId = null;
let myOwnerName = "";
let myOwnerEmail = "";
let familyEvents = [];

const calendarGrid = document.getElementById("calendarGrid");
const dayModalBg = document.getElementById("dayModalBg");
const eventModalBg = document.getElementById("eventModalBg");
const selectedDateDisplay = document.getElementById("selectedDateDisplay");
const eventForm = document.getElementById("eventForm");
const eventTitle = document.getElementById("eventTitle");
const eventTime = document.getElementById("eventTime");
const eventDesc = document.getElementById("eventDesc");
const eventDate = document.getElementById("eventDate");
const notification = document.getElementById("notification");

async function getProfileAndFamily() {
  const { data, error } = await supabase.auth.getUser();
  if (error || !data?.user) {
    showNotification("Please sign in.");
    return null;
  }

  const user = data.user;

  const { data: profile, error: profileError } = await supabase
    .from("profiles")
    .select("*")
    .eq("email", user.email)
    .single();

  if (profileError || !profile) {
    showNotification("No profile found.");
    return null;
  }

  myProfile = profile;
  myFamilyId = profile.family_id;
  myOwnerName = profile.name;
  myOwnerEmail = profile.email;
  return profile;
}

async function loadFamilyCalendar() {
  if (!myFamilyId) return;

  const { data, error } = await supabase
    .from("calendars")
    .select("events")
    .eq("family_id", myFamilyId)
    .single();

  if (error) {
    console.error("Failed to load calendar:", error);
    showNotification("Error loading calendar.");
    return;
  }

  familyEvents = data?.events || [];
  renderCalendar();
}

async function saveFamilyCalendar(events) {
  if (!myFamilyId) return;

  const { error } = await supabase
    .from("calendars")
    .upsert([{ family_id: myFamilyId, events }], { onConflict: ["family_id"] });

  if (error) {
    console.error("Supabase upsert error:", error);
    showNotification("Failed to save event: " + error.message);
  }
}

function renderCalendar() {
  if (!calendarGrid) return;

  calendarGrid.innerHTML = "";

  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const firstDay = new Date(year, month, 1).getDay();
  const lastDate = new Date(year, month + 1, 0).getDate();

  for (let i = 0; i < firstDay; i++) {
    const emptyCell = document.createElement("div");
    calendarGrid.appendChild(emptyCell);
  }

  for (let date = 1; date <= lastDate; date++) {
    const cell = document.createElement("div");
    cell.className = "calendar-cell";
    const fullDate = `${year}-${String(month + 1).padStart(2, "0")}-${String(date).padStart(2, "0")}`;
    cell.dataset.date = fullDate;
    cell.innerHTML = `<div>${date}</div>`;

    const eventsToday = familyEvents.filter(e => e.date === fullDate);
    eventsToday.forEach(e => {
      const badge = document.createElement("div");
      badge.className = "event-badge";
      badge.innerText = e.title;
      cell.appendChild(badge);
    });

    cell.onclick = () => openDayModal(fullDate);
    calendarGrid.appendChild(cell);
  }
}

function openDayModal(dateStr) {
  selectedDateDisplay.innerText = `Events on ${dateStr}`;
  const events = familyEvents.filter(e => e.date === dateStr);

  const list = document.getElementById("eventList");
  list.innerHTML = "";

  events.forEach(e => {
    const item = document.createElement("li");
    item.innerHTML = `<strong>${e.title}</strong> @ ${e.time || "all day"} â€” ${e.desc || ""}`;
    list.appendChild(item);
  });

  eventDate.value = dateStr;
  dayModalBg.style.display = "block";
}

document.getElementById("closeDayModal").onclick = () => {
  dayModalBg.style.display = "none";
};

document.getElementById("closeEventModal").onclick = () => {
  eventModalBg.style.display = "none";
};

document.getElementById("addEventButton").onclick = () => {
  dayModalBg.style.display = "none";
  eventModalBg.style.display = "block";
};

eventForm.onsubmit = async function (e) {
  e.preventDefault();

  if (!eventTitle.value || !eventDate.value) {
    showNotification("Please fill in the event title and date.");
    return;
  }

  const newEvent = {
    title: eventTitle.value.trim(),
    date: eventDate.value,
    time: eventTime.value,
    desc: eventDesc.value,
    owner: myOwnerName,
  };

  familyEvents.push(newEvent);
  await saveFamilyCalendar(familyEvents);
  await loadFamilyCalendar();

  eventModalBg.style.display = "none";
  showNotification("Event added and shared with your family!");
};

function showNotification(msg) {
  if (!notification) return;
  notification.innerText = msg;
  notification.style.display = "block";
  setTimeout(() => {
    notification.style.display = "none";
  }, 3000);
}

window.addEventListener("DOMContentLoaded", async () => {
  await getProfileAndFamily();
  await loadFamilyCalendar();
});

  </script>
</body>
</html>
